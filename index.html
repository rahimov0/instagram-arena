<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Takipçi Arenası – Battle Royale (15k+ Optimize)</title>
  <style>
    :root{--bg:#0b1015;--panel:#101821;--accent:#4ade80;--muted:#9aa4b2;--danger:#ef4444;--ring:#1f2937;--text:#e5e7eb}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial}
    body{margin:0;background:radial-gradient(1200px 800px at 70% 10%,#131c27,#0b1015);color:var(--text)}
    header{padding:20px 24px;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#0f1620,#0d141d)}
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .wrap{display:grid;grid-template-columns:420px 1fr;gap:16px;padding:16px}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
    .card h2{font-size:16px;margin:0;padding:14px 16px;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#121b25,#0f1722)}
    .card .body{padding:14px 16px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input[type="text"], input[type="file"], input[type="number"], textarea, select{width:100%;padding:10px;border-radius:10px;border:1px solid #263140;background:#0e1620;color:var(--text)}
    textarea{min-height:90px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:none;background:#111827;color:#e5e7eb;border:1px solid #253142;padding:10px 14px;border-radius:12px;cursor:pointer;transition:.2s all;font-weight:600}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(180deg,#16a34a,#15803d);border-color:#166534}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:#7f1d1d}
    .btn.ghost{background:transparent}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0d1620;border:1px solid #243041;color:#9aa4b2;border-radius:999px;padding:6px 10px;font-size:12px}
    .list{display:grid;gap:8px;max-height:220px;overflow:auto}
    .avatar{display:flex;align-items:center;gap:10px;background:#0b121b;border:1px solid #1e293b;padding:8px;border-radius:12px}
    .avatar img{width:34px;height:34px;border-radius:50%;object-fit:cover}
    .avatar .name{font-size:13px}
    canvas{width:100%;height:100%;display:block}
    #stageWrap{position:relative;border-radius:18px;overflow:hidden}
    #overlay{position:absolute;inset:0;pointer-events:none;display:flex;justify-content:space-between;align-items:flex-start;padding:12px}
    .hud{display:flex;gap:10px;flex-wrap:wrap}
    .winner{position:absolute;inset:auto 0 20px 0;display:flex;justify-content:center;pointer-events:none}
    .winner .msg{background:rgba(15,23,42,.8);backdrop-filter:blur(6px);border:1px solid #334155;padding:10px 14px;border-radius:12px;font-weight:700}
    .small{font-size:12px;color:var(--muted)}
    .slider{width:100%}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .sep{height:1px;background:#1f2937;margin:12px 0}
    .tip{font-size:12px;color:#93a2b5}
  </style>
</head>
<body>
  <header>
    <h1>Takipçi Arenası – Battle Royale (15k+ Optimize)</h1>
  </header>

  <div class="wrap">
    <section class="card" id="controls">
      <h2>Oyuncular & Kontroller</h2>
      <div class="body">
        <div class="grid2">
          <div>
            <label>İsim</label>
            <input id="nameInput" type="text" placeholder="ör. @kenan" />
          </div>
          <div>
            <label>Avatar (foto yükle)</label>
            <input id="fileInput" type="file" accept="image/*" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addBtn">Listeye ekle</button>
          <button class="btn ghost" id="addRandomBtn">Örnek oyuncu ekle</button>
        </div>

        <div class="sep"></div>
        <label>Toplu ekleme (Ad, Resim URL) — her satıra bir kişi</label>
        <textarea id="bulkInput" placeholder="@ali, https://site.com/ali.jpg\n@ayse, https://site.com/ayse.png"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="bulkBtn">Topluca ekle</button>
          <button class="btn ghost" id="clearBtn">Listeyi temizle</button>
        </div>

        <div class="sep"></div>
        <label>Instagram'dan içe aktar (followers.json / connections.json / CSV)</label>
        <div class="row" style="margin-top:8px">
          <input id="instaFile" type="file" accept=".json,.csv" />
          <button class="btn" id="importInstaBtn">İçe aktar (Instagram)</button>
        </div>
        <div class="small" style="margin-top:6px">Yol: Instagram ➜ <b>Ayarlar</b> ➜ <b>Hesap Merkezi</b> ➜ <b>Bilgilerin ve izinlerin</b> ➜ <b>Bilgilerini indir</b> ➜ <b>Seçili türler: Takipçiler ve Takip Edilenler</b> ➜ Format: <b>JSON</b> ➜ Tüm zamanlar. İndirilen arşivde <code>followers.json</code> veya <code>connections.json</code> dosyasını yükle.</div>

        <div class="sep"></div>
        <div class="grid2">
          <div>
            <label>Hız</label>
            <input id="speedSlider" class="slider" type="range" min="2" max="23" step="0.1" value="1" />
          </div>
          <div>
            <label>Çarpışma Hasarı</label>
            <input id="dmgSlider" class="slider" type="range" min="1" max="25" step="1" value="6" />
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>Başlangıç Canı</label>
            <input id="hpInput" type="number" value="60" />
          </div>
          <div>
            <label>Oyuncu Boyutu (px)</label>
            <input id="sizeInput" type="number" value="10" />
          </div>
        </div>

        <div class="sep"></div>
        <h3 style="font-size:13px;margin:0 0 8px">Daralan Çember</h3>
        <div class="grid2">
          <div>
            <label>Başlama Gecikmesi (sn)</label>
            <input id="shrinkDelay" type="number" value="10" />
          </div>
          <div>
            <label>Shrink Süresi (sn)</label>
            <input id="shrinkDuration" type="number" value="120" />
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>Dışarıda Hasar (HP/s)</label>
            <input id="stormDPS" type="number" value="15" />
          </div>
          <div>
            <label>Min Yarıçap (%)</label>
            <input id="minRadiusPercent" type="number" value="20" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="shrinkToggle">Daralma: Açık</button>
          <button class="btn ghost" id="shrinkReset">Daralmayı Sıfırla</button>
        </div>

        <div class="sep"></div>
        <h3 style="font-size:13px;margin:0 0 8px">Performans</h3>
        <div class="grid2">
          <div>
            <label>Avatar Görselleri</label>
            <select id="imgMode">
              <option value="auto" selected>Otomatik</option>
              <option value="off">Kapalı (renkli nokta)</option>
              <option value="on">Açık</option>
            </select>
          </div>
          <div>
            <label>FPS Azaltma (her N karede çiz)</label>
            <input id="renderEvery" type="number" min="1" max="4" value="2" />
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>Çarpışma Limiti / Kare</label>
            <input id="capCollisions" type="number" min="1000" max="200000" value="40000" />
          </div>
          <div>
            <label>—</label>
            <div class="pill">15k+ için: Görselleri kapat + N=2–3 + Boyut 8–12px</div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="startBtn">Başlat / Duraklat</button>
          <button class="btn" id="resetBtn">Sıfırla</button>
        </div>

        <div class="sep"></div>
        <div class="pill" id="stats">Oyuncu: 0 · Hayatta: 0</div>
        <div class="sep"></div>
        <div class="list" id="list"></div>

        <p class="tip" style="margin-top:10px">İpucu: Instagram profil fotoğraflarını kullanmadan önce izin alman iyi olur. Çok kalabalıkta <b>Görselleri: Kapalı</b> ve <b>Oyuncu Boyutu: 8–12px</b> kullan.</p>
      </div>
    </section>

    <section class="card" id="stageWrap" style="min-height:72vh">
      <h2>Arena</h2>
      <div class="body" style="padding:0">
        <div style="position:relative;aspect-ratio:16/9;min-height:520px">
          <canvas id="stage"></canvas>
          <div id="overlay">
            <div class="hud">
              <span class="pill" id="hudAlive">Hayatta: 0</span>
              <span class="pill" id="hudTime">Süre: 0 sn</span>
              <span class="pill" id="hudRing">Çember: 100%</span>
            </div>
            <div class="hud">
              <button class="btn" id="borderBtn">Sınır: Daire</button>
              <button class="btn" id="shuffleBtn">Konumları karıştır</button>
            </div>
          </div>
          <div class="winner" id="winner"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ====== Yardımcılar ======
    const $ = (id)=>document.getElementById(id);
    const clamp=(v,mi,ma)=>Math.max(mi,Math.min(ma,v));
    const gv=(id,def)=>{const el=$(id); if(!el) return def; const t=(el.tagName||'').toLowerCase(); if(t==='input'||t==='select'){ return (el.type==='number'||el.type==='range')? parseFloat(el.value)||def : (el.value||def);} return def; };

    function hashColor(str){ let h=0; for(let i=0;i<str.length;i++){ h=(h<<5)-h+str.charCodeAt(i); h|=0; } const hue=Math.abs(h)%360; return `hsl(${hue}deg 70% 55%)`; }

    // Baş harfli avatar (ucuz)
    function makeInitialAvatar(name, size=32){
      const c=document.createElement('canvas'); c.width=c.height=size; const ctx=c.getContext('2d');
      const hues=[190,210,160,280,20,340,120,45,260,305];
      ctx.fillStyle=`hsl(${hues[Math.floor(Math.random()*hues.length)]}deg 60% 20%)`; ctx.fillRect(0,0,size,size);
      ctx.fillStyle='white'; ctx.font=`bold ${Math.floor(size*0.44)}px system-ui`;
      ctx.textAlign='center'; ctx.textBaseline='middle';
      const initials=(name||'?').replace(/[@#]/g,'').trim().split(/\s+/).map(s=>s[0]?.toUpperCase()).slice(0,2).join('');
      ctx.fillText(initials||'?', size/2, size/2+1);
      const img=new Image(); img.src=c.toDataURL('image/png'); return img;
    }

    function fileToImage(file){ return new Promise((res,rej)=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=url;}); }
    function urlToImage(url){ return new Promise((res,rej)=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>res(img); img.onerror=()=>rej('Görsel yüklenemedi'); img.src=url;}); }

    // ====== Performans & Durum ======
    const perf={ dotThreshold:2000, tinyThreshold:8000, renderEvery:2, capCollisions:40000, imgMode:'auto' };

    const state={
      players:[], running:false, lastTime:0, elapsed:0, frame:0, border:'circle',
      ring:{enabled:true, delay:10, duration:120, stormDPS:15, minPercent:20, startRad:null, safeRad:null, active:false}
    };

    // Oyuncu modeli
    function createPlayer({name, img, hp, size}){
      const px=Math.random(), py=Math.random();
      const speed=(Math.random()*0.6+0.7)*(parseFloat(gv('speedSlider',1))||1);
      const angle=Math.random()*Math.PI*2; const r=(parseInt(gv('sizeInput',10))||10);
      const maxHp=parseInt(gv('hpInput',60))||60;
      return { id:crypto.randomUUID(), name:name||'Anon', img:img||makeInitialAvatar(name, 32),
        x:px, y:py, vx:Math.cos(angle)*speed*0.002, vy:Math.sin(angle)*speed*0.002,
        r:r, maxHp, hp:maxHp, alive:true, cooldown:0, _px:0, _py:0 };
    }

    // Liste UI
    function renderList(){ const list=$('list'); if(!list) return; list.innerHTML=''; const maxShow=200; state.players.slice(0,maxShow).forEach(p=>{ const row=document.createElement('div'); row.className='avatar'; const av=document.createElement('img'); av.src=p.img?.src||''; const nm=document.createElement('div'); nm.innerHTML=`<div class="name">${p.name}</div><div class="small">HP: ${Math.ceil(p.hp)}</div>`; const del=document.createElement('button'); del.className='btn danger'; del.textContent='Sil'; del.onclick=()=>{state.players=state.players.filter(x=>x.id!==p.id); updateStats(); renderList();}; row.append(av,nm,del); list.append(row); }); if(state.players.length>maxShow){ const more=document.createElement('div'); more.className='small'; more.textContent=`(+${state.players.length-maxShow} daha...)`; list.append(more); } }
    function updateStats(){ const total=state.players.length; const alive=state.players.filter(p=>p.alive).length; $('stats').textContent=`Oyuncu: ${total} · Hayatta: ${alive}`; $('hudAlive').textContent=`Hayatta: ${alive}`; }

    // ====== Canvas / Arena ======
    const canvas=$('stage'); const ctx=canvas.getContext('2d');
    function resize(){ const rect=canvas.parentElement.getBoundingClientRect(); const ratio=window.devicePixelRatio||1; canvas.width=rect.width*ratio; canvas.height=rect.height*ratio; ctx.setTransform(ratio,0,0,ratio,0,0); state.ring.startRad=null; state.ring.safeRad=null; }
    window.addEventListener('resize', resize); resize();

    function arena(){ const w=canvas.width/(window.devicePixelRatio||1); const h=canvas.height/(window.devicePixelRatio||1); const cx=w/2, cy=h/2; const rad=Math.min(w,h)*0.48; return {w,h,cx,cy,rad}; }

    // ====== Daralan Çember ======
    function updateRing(){
      const ar=arena();
      if(state.ring.startRad==null){ state.ring.startRad = ar.rad - 8; }
      const minRad = Math.max(ar.rad * (parseFloat(gv('minRadiusPercent',20))/100), 20);
      state.ring.delay = parseFloat(gv('shrinkDelay',10))||0;
      state.ring.duration = Math.max(1, parseFloat(gv('shrinkDuration',120))||120);
      state.ring.stormDPS = Math.max(0, parseFloat(gv('stormDPS',15))||0);

      if(state.ring.enabled){
        const t = clamp((state.elapsed - state.ring.delay) / state.ring.duration, 0, 1);
        state.ring.safeRad = state.ring.startRad + (minRad - state.ring.startRad) * t;
        state.ring.active = (state.elapsed >= state.ring.delay);
      } else { state.ring.safeRad = state.ring.startRad; state.ring.active=false; }

      const pct = clamp((state.ring.safeRad - minRad) / (state.ring.startRad - minRad), 0, 1);
      $('hudRing').textContent = `Çember: ${Math.round(pct*100)}%` + (state.ring.active? ' (daralıyor)':'' );
    }

    // ====== LOD Çizim ======
    function drawPlayer(p){
      const px=p._px, py=p._py; const count=state.players.length;
      const imgPref = gv('imgMode','auto');
      const forceDots = (imgPref==='off');
      const forceImages = (imgPref==='on');
      const lodDots = forceDots || (!forceImages && count>=perf.dotThreshold);
      const lodTiny = count>=perf.tinyThreshold;

      if(!lodDots){
        ctx.save(); ctx.beginPath(); ctx.arc(px,py,p.r,0,Math.PI*2); ctx.closePath(); ctx.clip(); ctx.drawImage(p.img, px-p.r, py-p.r, p.r*2, p.r*2); ctx.restore();
        if(count<1000){ // kalabalıkta HP halkası çizmiyoruz
          const ratio=clamp(p.hp/p.maxHp,0,1); const start=-Math.PI/2, end=start+Math.PI*2*ratio; ctx.lineWidth=3; ctx.strokeStyle='#111827'; ctx.beginPath(); ctx.arc(px,py,p.r+4,0,Math.PI*2); ctx.stroke(); ctx.strokeStyle=`hsl(${120*ratio}deg 70% 55%)`; ctx.beginPath(); ctx.arc(px,py,p.r+4,start,end); ctx.stroke();
        }
      } else { // hızlı nokta
        ctx.beginPath(); ctx.arc(px,py,lodTiny?Math.max(2,p.r*0.6):p.r,0,Math.PI*2); ctx.fillStyle=hashColor(p.name); ctx.fill();
      }
    }

    // ====== Fizik (Spatial Hash + limit) ======
    function physics(dt){
      const ar=arena(); const cell=40; const grid=new Map();
      // hareket
      for(const p of state.players){ if(!p.alive) continue; p.cooldown=Math.max(0,p.cooldown-dt); p.x += p.vx * dt * 60; p.y += p.vy * dt * 60; }
      // kenar & hash
      for(const p of state.players){ if(!p.alive) continue; const px = p._px = ar.cx + (p.x-0.5)*ar.rad*1.8; const py = p._py = ar.cy + (p.y-0.5)*ar.rad*1.8; const dx=px-ar.cx, dy=py-ar.cy; const dist=Math.hypot(dx,dy); const bound=ar.rad - p.r - 4; if(state.border==='circle'){ if(dist>bound){ const nx=dx/(dist||1), ny=dy/(dist||1); const dot=p.vx*nx+p.vy*ny; p.vx-=2*dot*nx; p.vy-=2*dot*ny; const over=dist-bound; p.x-=(over*nx)/(ar.rad*1.8); p.y-=(over*ny)/(ar.rad*1.8);} } else { const bx=ar.cx+Math.sign(dx)*bound, by=ar.cy+Math.sign(dy)*bound; if(Math.abs(dx)>bound){ p.vx*=-1; p.x=0.5+(bx-ar.cx)/(ar.rad*1.8);} if(Math.abs(dy)>bound){ p.vy*=-1; p.y=0.5+(by-ar.cy)/(ar.rad*1.8);} }
        const gx=Math.floor(px/cell), gy=Math.floor(py/cell); const key=gx+','+gy; (grid.get(key)||grid.set(key,[]).get(key)).push(p); }

      // çarpışmalar (komşu hücreler + limit)
      const neighbors=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,0],[0,1],[1,-1],[1,0],[1,1]]; let handled=0; const cap=parseInt(gv('capCollisions', perf.capCollisions))||perf.capCollisions;
      outer: for(const [key, bucket] of grid){ const [gx,gy]=key.split(',').map(Number); for(const p of bucket){ if(!p.alive) continue; for(const [ox,oy] of neighbors){ const nb=grid.get((gx+ox)+","+(gy+oy)); if(!nb) continue; for(const q of nb){ if(q===p||!q.alive) continue; const dx=q._px-p._px, dy=q._py-p._py; const dist=Math.hypot(dx,dy); const minDist=p.r+q.r; if(dist>0 && dist<minDist){ const overlap=(minDist-dist)/2; const nx=dx/dist, ny=dy/dist; p.x-=(overlap*nx)/(ar.rad*1.8); p.y-=(overlap*ny)/(ar.rad*1.8); q.x+=(overlap*nx)/(ar.rad*1.8); q.y+=(overlap*ny)/(ar.rad*1.8); // hız değişimi
              const vaN=p.vx*nx+p.vy*ny, vbN=q.vx*nx+q.vy*ny, tx=-ny, ty=nx, vaT=p.vx*tx+p.vy*ty, vbT=q.vx*tx+q.vy*ty; const vaN2=vbN, vbN2=vaN; p.vx=vaN2*nx+vaT*tx; p.vy=vaN2*ny+vaT*ty; q.vx=vbN2*nx+vbT*tx; q.vy=vbN2*ny+vbT*ty; // sabit hasar
              const dmg=(parseFloat(gv('dmgSlider',6))||6); if(p.cooldown<=0){ p.hp-=dmg; p.cooldown=0.12; if(p.hp<=0) p.alive=false; } if(q.cooldown<=0){ q.hp-=dmg; q.cooldown=0.12; if(q.hp<=0) q.alive=false; }
              if(++handled>cap) break outer; } } } } }

      // fırtına hasarı (safe zone dışı)
      updateRing(); const safe = state.ring.safeRad ?? (ar.rad-8); const dps = state.ring.stormDPS; for(const p of state.players){ if(!p.alive) continue; const dx=p._px-ar.cx, dy=p._py-ar.cy; const dist=Math.hypot(dx,dy); if(dist > safe - p.r){ p.hp -= dps * dt; if(p.hp<=0){ p.alive=false; } } }
    }

    // ====== Çizim ======
    function draw(){
      const ar=arena();
      const grd=ctx.createRadialGradient(ar.cx,ar.cy,10, ar.cx,ar.cy,ar.rad+160); grd.addColorStop(0,'#0b1320'); grd.addColorStop(1,'#060b12'); ctx.fillStyle=grd; ctx.fillRect(0,0,ar.w,ar.h);
      // Arena duvarı
      ctx.save(); ctx.strokeStyle='rgba(59,130,246,0.9)'; ctx.lineWidth=8; ctx.setLineDash([6,10]); if(state.border==='circle'){ ctx.beginPath(); ctx.arc(ar.cx,ar.cy,ar.rad,0,Math.PI*2); ctx.stroke(); } else { ctx.strokeRect(ar.cx-ar.rad, ar.cy-ar.rad, ar.rad*2, ar.rad*2); } ctx.restore();
      // Safe zone overlay
      const safe = state.ring.safeRad ?? (ar.rad-8);
      ctx.save(); ctx.fillStyle='rgba(239,68,68,0.06)'; ctx.beginPath(); ctx.rect(0,0,ar.w,ar.h); ctx.moveTo(ar.cx+safe, ar.cy); ctx.arc(ar.cx, ar.cy, safe, 0, Math.PI*2, true); ctx.fill('evenodd'); ctx.strokeStyle='rgba(239,68,68,0.85)'; ctx.lineWidth=3; ctx.setLineDash([10,10]); ctx.beginPath(); ctx.arc(ar.cx,ar.cy,safe,0,Math.PI*2); ctx.stroke(); ctx.restore();
      // Oyuncular
      for(const p of state.players){ if(p.alive) drawPlayer(p); }
      for(const p of state.players){ if(!p.alive && p._px){ ctx.save(); ctx.globalAlpha=0.18; ctx.beginPath(); ctx.arc(p._px,p._py,p.r,0,Math.PI*2); ctx.fillStyle='#0f172a'; ctx.fill(); ctx.restore(); }}
      // HUD / kazanan
      const alive=state.players.filter(p=>p.alive); $('hudAlive').textContent=`Hayatta: ${alive.length}`; $('hudTime').textContent=`Süre: ${Math.floor(state.elapsed)} sn`; if(alive.length===1 && state.running){ state.running=false; $('winner').innerHTML=`<div class="msg">🎉 Kazanan: ${alive[0].name}</div>`; }
    }

    // ====== Döngü ======
    function loop(ts){ if(!state.lastTime) state.lastTime=ts; const dt=Math.min(0.05,(ts-state.lastTime)/1000); state.lastTime=ts; if(state.running){ state.elapsed+=dt; physics(dt); }
      state.frame=(state.frame+1)|0; const N=parseInt(gv('renderEvery', perf.renderEvery))||perf.renderEvery; if(state.frame%N===0) draw(); requestAnimationFrame(loop); }
    requestAnimationFrame(loop);

    // ====== Etkileşimler ======
    $('addBtn').onclick=async()=>{ const name=$('nameInput').value.trim()||'Anon'; let img=null; const file=$('fileInput').files[0]; if(file){ img=await fileToImage(file); } else { img=makeInitialAvatar(name,32); } const p=createPlayer({name,img,hp:gv('hpInput',60),size:gv('sizeInput',10)}); state.players.push(p); renderList(); updateStats(); $('nameInput').value=''; $('fileInput').value=''; };
    $('addRandomBtn').onclick=()=>{ const nick='@user'+Math.floor(Math.random()*999999); const p=createPlayer({name:nick,img:makeInitialAvatar(nick,32),hp:gv('hpInput',60),size:gv('sizeInput',10)}); state.players.push(p); renderList(); updateStats(); };

    // Büyük listeler: 1000'erlik parçalara böl (UI donmasın)
    $('bulkBtn').onclick=async()=>{
 const lines = $('bulkInput').value.split(/\r?\n+/).map(s => s.trim()).filter(Boolean);

  const chunk=1000;
  for(let i=0;i<lines.length;i+=chunk){
    const part=lines.slice(i,i+chunk);
    await new Promise(r=>setTimeout(r,0));
    for(const line of part){
      const m=line.match(/^(.*?),(.*)$/); let name,img;
      if(m){ name=m[1].trim(); const url=m[2].trim(); try{ img=await urlToImage(url);}catch{ img=makeInitialAvatar(name,32);} }
      else { name=line; img=makeInitialAvatar(name,32); }
      state.players.push(createPlayer({name,img,hp:gv('hpInput',60),size:gv('sizeInput',10)}));
    }
    updateStats();
  }
  $('bulkInput').value='';
  renderList();
};

    // Instagram JSON/CSV içe aktar
    $('importInstaBtn').onclick = async ()=>{
  const inp = $('instaFile');
  const file = inp && inp.files && inp.files[0];
  if(!file){ alert('Önce dosya seç. (followers.json / connections.json / CSV)'); return; }
  const name = file.name.toLowerCase();
  try {
    let usernames=[];
    const text = await file.text();
    if(name.endsWith('.json')){
      const data = JSON.parse(text);
      usernames = extractUsernamesFromInstagramJSON(data);
    } else { // CSV
      usernames = text.split(/\r?\n+/).map(s => s.trim()).filter(Boolean).map(s => s.replace(/^@/, ''));

    }
    if(!usernames.length){ alert('Kullanıcı adı bulunamadı. JSON doğru dosya mı?'); return; }
    const chunk=1000; let added=0;
    for(let i=0;i<usernames.length;i+=chunk){
      const part=usernames.slice(i,i+chunk);
      await new Promise(r=>setTimeout(r,0));
      for(const u of part){ const nick='@'+u; const p=createPlayer({name:nick,img:makeInitialAvatar(nick,32),hp:gv('hpInput',60),size:gv('sizeInput',10)}); state.players.push(p); added++; }
      updateStats();
    }
    renderList(); inp.value=''; alert('İçe aktarıldı: '+added+' kullanıcı');
  } catch(e){ console.error(e); alert('İçe aktarma başarısız: '+e); }
};

    function extractUsernamesFromInstagramJSON(root){
      const out=new Set();
      const walk=(node)=>{
        if(Array.isArray(node)){ for(const v of node) walk(v); return; }
        if(node && typeof node==='object'){
          if(node.string_list_data && Array.isArray(node.string_list_data)){
            for(const s of node.string_list_data){ if(s && s.value) out.add(String(s.value).replace(/^@/,'').trim()); }
          }
          for(const v of Object.values(node)) walk(v);
        }
      };
      walk(root);
      return Array.from(out);
    }

    $('clearBtn').onclick=()=>{ state.players=[]; renderList(); updateStats(); $('winner').innerHTML=''; state.elapsed=0; state.ring.startRad=null; state.ring.safeRad=null; };

    $('startBtn').onclick=()=>{ if(state.players.filter(p=>p.alive).length<2){ alert('En az 2 oyuncu ekle!'); return; } state.running=!state.running; if(state.running) $('winner').innerHTML=''; };
    $('resetBtn').onclick=()=>{ state.players.forEach(p=>{ p.hp=p.maxHp; p.alive=true; }); state.elapsed=0; state.running=false; $('winner').innerHTML=''; updateStats(); state.ring.startRad=null; state.ring.safeRad=null; };

    $('speedSlider').oninput=()=>{ const v=parseFloat(gv('speedSlider',1)); state.players.forEach(p=>{ const ang=Math.atan2(p.vy,p.vx); const base=0.002*v; p.vx=Math.cos(ang)*base; p.vy=Math.sin(ang)*base; }); };
    $('borderBtn').onclick=()=>{ state.border = state.border==='circle'?'square':'circle'; $('borderBtn').textContent='Sınır: '+(state.border==='circle'?'Daire':'Kare'); };
    $('shuffleBtn').onclick=()=>{ state.players.forEach(p=>{ p.x=Math.random(); p.y=Math.random(); const a=Math.random()*Math.PI*2; const sp=(Math.random()*0.6+0.7)*(parseFloat(gv('speedSlider',1))||1); p.vx=Math.cos(a)*sp*0.002; p.vy=Math.sin(a)*sp*0.002; }); };
    $('imgMode').onchange=()=>{ perf.imgMode=gv('imgMode','auto'); };
    $('shrinkToggle').onclick=()=>{ state.ring.enabled=!state.ring.enabled; $('shrinkToggle').textContent = 'Daralma: '+(state.ring.enabled?'Açık':'Kapalı'); };
    $('shrinkReset').onclick=()=>{ state.ring.startRad=null; state.ring.safeRad=null; state.elapsed=0; };

    // Örnekler (küçük set)
    const samples=['@ayse','@mehmet','@zeynep','@kerem']; samples.forEach(n=>{ state.players.push(createPlayer({name:n,img:makeInitialAvatar(n,32),hp:gv('hpInput',60),size:gv('sizeInput',10)})); }); renderList(); updateStats();
  </script>
</body>
</html>
